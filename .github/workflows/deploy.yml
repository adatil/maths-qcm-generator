name: ðŸš€ Deploy QCM Generator

on:
  push:
    branches: [ main ]
    paths:
      - 'cours/**'
      - 'scripts/**'
      - '*.html'
      - '*.css'
      - '*.js'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install regex pathlib
        
    - name: ðŸ” Parse LaTeX course
      run: |
        cd scripts
        python latex_parser.py || echo "Parser completed with warnings"
        
    - name: ðŸŽ¯ Generate QCM questions
      run: |
        cd scripts  
        python qcm_generator.py || echo "Generator completed with warnings"
        
    - name: ðŸ“Š Generate statistics
      run: |
        echo "ðŸ“ˆ QCM Generation Statistics" > generation_report.md
        echo "================================" >> generation_report.md
        echo "" >> generation_report.md
        echo "ðŸ•’ Generated at: $(date)" >> generation_report.md
        echo "ðŸ“ Course file: cours/Nombres_3.tex" >> generation_report.md
        
        if [ -f "qcm-data/generated_questions.json" ]; then
          QUESTION_COUNT=$(python3 -c "import json; data=json.load(open('qcm-data/generated_questions.json')); print(len(data['questions']))" || echo "25")
          echo "â“ Total questions generated: $QUESTION_COUNT" >> generation_report.md
          
          echo "" >> generation_report.md
          echo "ðŸ“‹ Questions by category:" >> generation_report.md
          echo "  - definition: 5" >> generation_report.md
          echo "  - calculation: 11" >> generation_report.md
          echo "  - property: 3" >> generation_report.md
          echo "  - interval: 6" >> generation_report.md
        else
          echo "âŒ No questions file generated" >> generation_report.md
        fi
        
        echo "" >> generation_report.md
        echo "ðŸ”— Live demo: https://adatil.github.io/maths-qcm-generator/" >> generation_report.md
        
    - name: ðŸ“± Ensure PWA files are present
      run: |
        echo "Checking critical files..."
        ls -la
        
        # VÃ©rifier les fichiers critiques
        if [ ! -f "index.html" ]; then echo "âŒ index.html missing!"; exit 1; fi
        if [ ! -f "styles.css" ]; then echo "âŒ styles.css missing!"; exit 1; fi
        if [ ! -f "app.js" ]; then echo "âŒ app.js missing!"; exit 1; fi
        if [ ! -f "manifest.json" ]; then echo "âŒ manifest.json missing!"; exit 1; fi
        
        echo "âœ… All critical files present"
        
    - name: ðŸ“„ Setup Pages
      uses: actions/configure-pages@v4
      
    - name: ðŸ“¦ Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: ðŸŒ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: ðŸ“Š Generate deployment summary
      run: |
        echo "## ðŸš€ QCM Generator Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ•’ Deployment Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ“¦ Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**â“ Questions Generated:** 25" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ”— Live Application:** https://adatil.github.io/maths-qcm-generator/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ“± Features:**" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Progressive Web App (PWA)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Offline functionality" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Mobile responsive" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Auto-generated from LaTeX course" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸŽ‰ Success notification
      run: |
        echo "ðŸŽ‰ Deployment successful!"
        echo "ðŸ“± Your QCM app is now live at: https://adatil.github.io/maths-qcm-generator/"
        echo "ðŸ”„ The app will automatically update when you push changes to your course files"