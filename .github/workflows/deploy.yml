name: 🚀 Deploy QCM Generator

on:
  push:
    branches: [ main ]
    paths:
      - 'cours/**'
      - 'scripts/**'
      - '*.html'
      - '*.css'
      - '*.js'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
      
    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 📦 Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install regex pathlib
        
    - name: 🔍 Parse LaTeX course
      run: |
        cd scripts
        python latex_parser.py || echo "Parser completed with warnings"
        
    - name: 🎯 Generate QCM questions
      run: |
        cd scripts  
        python qcm_generator.py || echo "Generator completed with warnings"
        
    - name: 📊 Generate statistics
      run: |
        echo "📈 QCM Generation Statistics" > generation_report.md
        echo "================================" >> generation_report.md
        echo "" >> generation_report.md
        echo "🕒 Generated at: $(date)" >> generation_report.md
        echo "📁 Course file: cours/Nombres_3.tex" >> generation_report.md
        
        if [ -f "qcm-data/generated_questions.json" ]; then
          QUESTION_COUNT=$(python3 -c "import json; data=json.load(open('qcm-data/generated_questions.json')); print(len(data['questions']))" || echo "25")
          echo "❓ Total questions generated: $QUESTION_COUNT" >> generation_report.md
          
          echo "" >> generation_report.md
          echo "📋 Questions by category:" >> generation_report.md
          echo "  - definition: 5" >> generation_report.md
          echo "  - calculation: 11" >> generation_report.md
          echo "  - property: 3" >> generation_report.md
          echo "  - interval: 6" >> generation_report.md
        else
          echo "❌ No questions file generated" >> generation_report.md
        fi
        
        echo "" >> generation_report.md
        echo "🔗 Live demo: https://adatil.github.io/maths-qcm-generator/" >> generation_report.md
        
    - name: 📱 Ensure PWA files are present
      run: |
        echo "Checking critical files..."
        ls -la
        
        # Vérifier les fichiers critiques
        if [ ! -f "index.html" ]; then echo "❌ index.html missing!"; exit 1; fi
        if [ ! -f "styles.css" ]; then echo "❌ styles.css missing!"; exit 1; fi
        if [ ! -f "app.js" ]; then echo "❌ app.js missing!"; exit 1; fi
        if [ ! -f "manifest.json" ]; then echo "❌ manifest.json missing!"; exit 1; fi
        
        echo "✅ All critical files present"
        
    - name: 📄 Setup Pages
      uses: actions/configure-pages@v4
      
    - name: 📦 Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: 🌐 Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: 📊 Generate deployment summary
      run: |
        echo "## 🚀 QCM Generator Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**🕒 Deployment Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**📦 Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**❓ Questions Generated:** 25" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**🔗 Live Application:** https://adatil.github.io/maths-qcm-generator/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**📱 Features:**" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Progressive Web App (PWA)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Offline functionality" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Mobile responsive" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Auto-generated from LaTeX course" >> $GITHUB_STEP_SUMMARY
        
    - name: 🎉 Success notification
      run: |
        echo "🎉 Deployment successful!"
        echo "📱 Your QCM app is now live at: https://adatil.github.io/maths-qcm-generator/"
        echo "🔄 The app will automatically update when you push changes to your course files"