name: ğŸš€ Deploy QCM Generator

on:
  push:
    branches: [ main ]
    paths:
      - 'cours/**'
      - 'scripts/**'
      - '*.html'
      - '*.css'
      - '*.js'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install regex json pathlib
        
    - name: ğŸ” Parse LaTeX course
      run: |
        cd scripts
        python latex_parser.py
        
    - name: ğŸ¯ Generate QCM questions
      run: |
        cd scripts  
        python qcm_generator.py
        
    - name: ğŸ“Š Generate statistics
      run: |
        echo "ğŸ“ˆ QCM Generation Statistics" > generation_report.md
        echo "================================" >> generation_report.md
        echo "" >> generation_report.md
        echo "ğŸ•’ Generated at: $(date)" >> generation_report.md
        echo "ğŸ“ Course file: cours/Nombres_3.tex" >> generation_report.md
        
        if [ -f "qcm-data/generated_questions.json" ]; then
          QUESTION_COUNT=$(python3 -c "import json; data=json.load(open('qcm-data/generated_questions.json')); print(len(data['questions']))")
          echo "â“ Total questions generated: $QUESTION_COUNT" >> generation_report.md
          
          CATEGORIES=$(python3 -c "import json; data=json.load(open('qcm-data/generated_questions.json')); cats={}; [cats.update({q['category']: cats.get(q['category'], 0) + 1}) for q in data['questions']]; [print(f'{k}: {v}') for k,v in cats.items()]")
          echo "" >> generation_report.md
          echo "ğŸ“‹ Questions by category:" >> generation_report.md
          echo "$CATEGORIES" | sed 's/^/  - /' >> generation_report.md
        else
          echo "âŒ No questions file generated" >> generation_report.md
        fi
        
        echo "" >> generation_report.md
        echo "ğŸ”— Live demo: https://adatil.github.io/maths-qcm-generator/" >> generation_report.md
        
    - name: ğŸ“± Generate PWA icons (mock)
      run: |
        mkdir -p icons
        # CrÃ©ation d'icÃ´nes basiques avec ImageMagick (si disponible) ou placeholders
        echo "Generating PWA icons..."
        
        # CrÃ©er un placeholder SVG simple
        cat > icons/icon-base.svg << 'EOF'
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
          <rect width="512" height="512" fill="#3B82F6" rx="64"/>
          <text x="256" y="280" font-family="Arial, sans-serif" font-size="200" fill="white" text-anchor="middle">ğŸ§®</text>
          <text x="256" y="350" font-family="Arial, sans-serif" font-size="48" fill="white" text-anchor="middle">QCM</text>
          <text x="256" y="400" font-family="Arial, sans-serif" font-size="32" fill="#E5E7EB" text-anchor="middle">MATHS</text>
        </svg>
        EOF
        
        # Si ImageMagick n'est pas disponible, crÃ©er des copies du SVG
        for size in 72 96 128 144 152 192 384 512; do
          cp icons/icon-base.svg "icons/icon-${size}x${size}.png"
        done
        
    - name: ğŸ› ï¸ Setup Node.js (for GitHub Pages deployment)
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“‹ Create build info
      run: |
        echo "{
          \"buildTime\": \"$(date -Iseconds)\",
          \"commit\": \"${{ github.sha }}\",
          \"branch\": \"${{ github.ref_name }}\",
          \"repository\": \"${{ github.repository }}\"
        }" > build-info.json
        
    - name: ğŸ¨ Optimize for deployment
      run: |
        # Minifier le CSS et JS si nÃ©cessaire (optionnel)
        echo "Optimization step (placeholder for future enhancements)"
        
        # S'assurer que tous les fichiers nÃ©cessaires sont prÃ©sents
        ls -la
        
        # VÃ©rifier les fichiers critiques
        if [ ! -f "index.html" ]; then echo "âŒ index.html missing!"; exit 1; fi
        if [ ! -f "styles.css" ]; then echo "âŒ styles.css missing!"; exit 1; fi
        if [ ! -f "app.js" ]; then echo "âŒ app.js missing!"; exit 1; fi
        if [ ! -f "manifest.json" ]; then echo "âŒ manifest.json missing!"; exit 1; fi
        
        echo "âœ… All critical files present"
        
    - name: ğŸ“Š Generate deployment summary
      run: |
        echo "## ğŸš€ QCM Generator Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ•’ Deployment Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ“¦ Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "qcm-data/generated_questions.json" ]; then
          QUESTION_COUNT=$(python3 -c "import json; data=json.load(open('qcm-data/generated_questions.json')); print(len(data['questions']))")
          echo "**â“ Questions Generated:** $QUESTION_COUNT" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ”— Live Application:** https://adatil.github.io/maths-qcm-generator/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ“± Features:**" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Progressive Web App (PWA)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Offline functionality" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Mobile responsive" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Auto-generated from LaTeX course" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸŒ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        exclude_assets: '.github,scripts/latex_parser.py,scripts/qcm_generator.py,cours'
        
    - name: ğŸ‰ Success notification
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸ“± Your QCM app is now live at: https://adatil.github.io/maths-qcm-generator/"
        echo "ğŸ”„ The app will automatically update when you push changes to your course files"